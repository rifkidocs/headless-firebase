rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper to check if a user is an admin
    function isAdmin() {
      return request.auth != null; // Simple check for now, can be extended
    }

    // Helper to check public permissions
    function hasPublicPermission(collection, action) {
      return get(/databases/$(database)/documents/_permissions/$(collection)).data[action] == true;
    }

    // Roles and Permissions are admin-only
    match /_roles/{role} {
      allow read, write: if isAdmin();
    }
    
    match /_permissions/{permission} {
      allow read: if true; // Public needs to read these to verify access
      allow write: if isAdmin();
    }

    match /_collections/{collection} {
      allow read, write: if isAdmin();
    }

    // Dynamic collections
    match /{collectionSlug}/{documentId} {
      allow read: if isAdmin() || hasPublicPermission(collectionSlug, 'find') || hasPublicPermission(collectionSlug, 'findOne');
      allow create: if isAdmin() || hasPublicPermission(collectionSlug, 'create');
      allow update: if isAdmin() || hasPublicPermission(collectionSlug, 'update');
      allow delete: if isAdmin() || hasPublicPermission(collectionSlug, 'delete');
    }
  }
}
